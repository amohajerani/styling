{% extends "base.html" %} {% block title %}Past entries{% endblock %} {% block content %}
<div class="content">
	<h1>Subscriber List</h1>
	
	<!-- Subscriber list -->
	<h2>Current Subscribers:</h2>
	<ul id="subscriber-list">
		<!-- List items will be added dynamically via JavaScript -->
	</ul>

	<!-- Subscription list -->
	<h2>Current Subscriptions:</h2>
	<ul id="subscription-list">
		<!-- List items will be added dynamically via JavaScript -->
	</ul>


	<!-- Add new subscriber form -->
	<h2>Add New Subscriber:</h2>
	<form id="subscribe-form">
		<label for="email">Email Address:</label>
		<input type="email" id="email" name="email" required>
		<button type="submit">Subscribe</button>
	</form>
	
	<script>
		// Fetch initial list of subscriptions
		fetch('/get-subscriptions')
			.then(response => response.json())
			.then(subscriptions => {
				const subscriptionList = document.querySelector('#subscription-list');
				subscriptions.forEach(subscription => {
					console.log('subscription: ',subscription)
					const listItem = document.createElement('li');
					const link = document.createElement('a');
					const encodedSubscription = encodeURIComponent(subscription);
      				link.href = '/subscription/' + encodedSubscription;
      				link.textContent = subscription;
					listItem.appendChild(link);
					subscriptionList.appendChild(listItem);
				});
			})
			.catch(error => console.log(error));


		// Fetch initial list of subscribers
		fetch('/get-subscribers')
			.then(response => response.json())
			.then(subscribers => {
				const subscriberList = document.querySelector('#subscriber-list');
				subscribers.forEach(subscriber => {
					const listItem = document.createElement('li');
					listItem.textContent = subscriber;
					const deleteButton = document.createElement('button');
					deleteButton.classList.add('delete-button');
					deleteButton.dataset.email = subscriber;
					deleteButton.textContent = 'Delete';
					deleteButton.addEventListener('click', event => {
						const email = deleteButton.dataset.email;
						const listItem = deleteButton.parentElement;
						removeSubscriber(email, listItem);
					});
					listItem.appendChild(deleteButton);
					subscriberList.appendChild(listItem);
				});
			})
			.catch(error => console.log(error));
		
		// Add event listener to subscribe form
		const subscribeForm = document.querySelector('#subscribe-form');
		subscribeForm.addEventListener('submit', event => {
			event.preventDefault();
			const emailInput = document.querySelector('#email');
			const email = emailInput.value;
			addSubscriber(email);
			emailInput.value = '';
		});
		
		// Function to add subscriber
		function addSubscriber(email) {
			fetch('/add-subscriber', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: `email=${encodeURIComponent(email)}`
			})
			.then(response => response.text())
			.then(subscriber => {
				const subscriberList = document.querySelector('#subscriber-list');
				const listItem = document.createElement('li');
				listItem.textContent = subscriber;
				const deleteButton = document.createElement('button');
				deleteButton.classList.add('delete-button');
				deleteButton.dataset.email = subscriber;
				deleteButton.textContent = 'Delete';
				deleteButton.addEventListener('click', event => {
					const email = deleteButton.dataset.email;
					const listItem = deleteButton.parentElement;
					removeSubscriber(email, listItem);
				});
				listItem.appendChild(deleteButton);
				subscriberList.appendChild(listItem);
			})
			.catch(error => console.log(error));
		}
		
		// Function to remove subscriber
		function removeSubscriber(email, listItem) {
			fetch('/remove-subscriber', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: `email=${encodeURIComponent(email)}`
			})
			.then(response => {
				if (response.ok) {
					listItem.remove();
				} else {
					console.log('Error removing subscriber');
				}
			})
			.catch(error => console.log(error));
		}
	</script>
</div>
{% endblock %}
